<html>
<head>
<title>They Are Billions Tech Tree Calculator</title>
<script>
  const tType=0;
  const tName=1;
  const tEffect=2;
  const tPoints=3;
  const tReq=4;
  const tX=5;
  const tY=6;
  const tActive=7;
  const tR=8;
  const tP=9;

  //   0      1      2        3        4     5   6   7 
  // ["Type","Name","Effect","Points","Req","x","y","Active","R","P"],
  const tech = [
    ["Economy Tech","Steam Tech","Basic Steam Tech","0","","0","4",true,[],[]],

    ["Economy Tech","Bearings and Pulleys","Fisherman Cottage: Food+20%","100","Steam Tech","1","1",false,[],[]],
    ["Unit","Assault Rifle","New Unit: Soldier","120","Steam Tech","1","3",false,[],[]],
    ["Military Tech","Mercenaries I","Extra Unit: Ranger","100","Steam Tech","1","5",false,[],[]],
    ["Military Building","High-Rise Def I","New Structure: Wood Tower","100","Steam Tech","1","6",false,[],[]],
    ["Economy Tech","Logistics","Command Center: Gold+40 and Storage+20","100","Steam Tech","1","8",false,[],[]],

    ["Economy Tech","Efficient Turbines","Mill: Energy+30%","120","Bearings and Pulleys","2","1",false,[],[]],
    ["Military Tech","Military Training","Buildings: Def+20%\nExtra Unit: Soldier","100","Assault Rifle","2","2",false,[],[]],
    ["Economy Tech","Hunting Weapons","Hunters Cottage: Food+20%","100","Assault Rifle","2","3",false,[],[]],
    ["Military Tech","Mercenaries II","Extra Unit: Sniper","100","Mercenaries I","2","5",false,[],[]],
    ["Military Tech","Wood Buttresses","Wood Defenses: Life+20%","120","High-Rise Def I","2","6",false,[],[]],
    ["Economy Tech","Basic Supplies","Command Center: Food+20\nEnergy+20","100","Logistics","2","7",false,[],[]],
    ["Economy Tech\nTrain","Gold Transportation","Train Gold+200 (every 24h)","120","Logistics","2","9",false,[],[]],

    ["Economy Building","Expert Workshops","New Structure: Wood Workshop\nNew Structure: Cottage","240","Steam Tech","3","4",false,[],[]],
    ["Economy Building","Mechanized Storage","New Structure: Warehouse","120","Expert Workshops\nLogistics","3","8",false,[],[]],

    ["Economy Building","Cereal Farming","New Structure: Farm","120","Expert Workshops","4","1",false,[],[]],
    ["Military Tech","Reinforced Armor","Soldier: Armor+20%","100","Expert Workshops","4","2",false,[],[]],
    ["Military Tech","Reinforced Projectiles","Ranger: Damage+20%","100","Expert Workshops","4","3",false,[],[]],
    ["Military Tech","Optics","Command Center: Range+5","100","Expert Workshops","4","5",false,[],[]],
    ["Military Building","Barricades","New Structure: Stakes Trap","80","Expert Workshops\nWood Buttresses","4","6",false,[],[]],
    ["Military Tech","Medicine","Soldier: Life+20%\nRanger: Life+20%\nSniper: Life+20%","140","Expert Workshops\nBasic Supplies","4","7",false,[],[]],
    ["Economy Tech","Structure Recycling","Structures: +30% destroying refund","140","Expert Workshops\nMechanized Storage","4","8",false,[],[]],
    ["Economy Tech\nTrain","Wood Transportation","Train Wood+15 (every 24h)","140","Expert Workshops\nGold Transportation","4","9",false,[],[]],

    ["Economy Building","Commerce","New Structure: Market","120","Expert Workshops\nCereal Farming","5","1",false,[],[]],
    ["Military Tech","Professional Soldier","Extra Unit: Soldier","80","Expert Workshops\nReinforced Armor","5","2",false,[],[]],
    ["Military Building","Mechanized Weapons","New Structure: Great Ballista","140","Expert Workshops\nReinforced Projectiles","5","3",false,[],[]],
    ["Military Building","Advanced Lens","New Structure: Lookout Tower","120","Expert Workshops\nOptics","5","5",false,[],[]],
    ["Military Tech","Long Range Rifle","Soldier: View Range+1 and Attack Range+1","100","Expert Workshops\nOptics","5","6",false,[],[]],
    ["Research Tech","Advanced Laboratory","Research: Time-25%","120","Expert Workshops\nMedicine","5","7",false,[],[]],
    ["Economy Tech","Corpse Recycling","Infected Kill: Gold+1","100","Expert Workshops\nStructure Recycling","5","8",false,[],[]],

    ["Economy Building\nMilitary Building","Lodging","New Structure: Inn","140","Expert Workshops\nCommerce","6","0",false,[],[]],
    ["Military Tech","Prefabricated Parts","Extra Building: Great Ballista","100","Expert Workshops\nMechanized Weapons","6","3",false,[],[]],
    ["Unit","Telescopic Sight","New Unit: Sniper","140","Expert Workshops\nAdvanced Lens","6","5",false,[],[]],
    ["Military Building","Global Vision","Wonder: The Silent Beholder","200","Expert Workshops\nLong Range Rifle","6","6",false,[],[]],
    ["Economy Tech\nTrain","Stone Transportation","Train Stone+8 (every 24h)","160","Expert Workshops\nWood Transportation","6","9",false,[],[]],

    ["Military Tech","Games and Gambling","Inn: Mercenaries every 3 days","120","Expert Workshops\nLodging","7","0",false,[],[]],
    ["Economy Building","Advanced Construction","New Structure: Stone Workshop\nNew Structure: Stone House","260","Expert Workshops","7","4",false,[],[]],

    ["Economy Tech","Tesla Coils","Command Center: Energy Radius+4 and Energy+20%","100","Advanced Construction","8","1",false,[],[]],
    ["Economy Building","Thermal Energy","New Structure: Power Plant","120","Advanced Construction","8","2",false,[],[]],
    ["Military Tech","Advanced Training","Soldier: Training Time -10%\nRanger: Training Time -10%\nSniper: Training Time -10%","100","Advanced Construction","8","3",false,[],[]],
    ["Military Building","Concrete","New Structure: Stone Wall\nNew Structure: Stone Gate","120","Advanced Construction","8","5",false,[],[]],
    ["Military Tech","Chemistry","Soldier: Damage+20%","120","Advanced Construction","8","7",false,[],[]],
    ["Economy Tech\nTrain","Iron Transportation","Train Iron+6 (every 24h)","200","Advanced Construction\nStone Transportation","8","9",false,[],[]],

    ["Economy Tech","Advanced Tesla Transfer","Tesla Tower: Energy Radius+1\nView+1","200","Advanced Construction\nTesla Coils","9","0",false,[],[]],
    ["Military Building","Explosives","New Structure: Land Mines","120","Advanced Construction\nThermal Energy","9","2",false,[],[]],
    ["Military Tech","Military Tactics","Units: Vet Exp-20%","120","Advanced Construction\nAdvanced Training","9","3",false,[],[]],
    ["Economy Building","Currency","New Structure: Bank","140","Advanced Construction\nConcrete","9","5",false,[],[]],
    ["Military Building","High-Rise Def II","New Structure: Stone Tower","80","Advanced Construction\nConcrete","9","6",false,[],[]],
    ["Economy Tech","Insulating Materials","Cottage: Energy-1\nStone House: Energy-2","140","Advanced Construction\nChemistry","9","7",false,[],[]],
    ["Military Building","Autonomous Weapons","New Structure: Wasp","120","Advanced Construction\nChemistry","9","8",false,[],[]],

    ["Military Building","Plasma Spheres","New Structure: Shocking Tower","140","Advanced Construction\nTesla Coils","10","1",false,[],[]],
    ["Military Building","Military Mastery","Wonder: The Academy of Immortals","200","Advanced Construction\nMilitary Tactics","10","3",false,[],[]],
    ["Economy Tech","Black Market","Infected Kill: Gold+1","140","Advanced Construction\nCurrency","10","5",false,[],[]],
    ["Military Tech","Reinforced Concrete","Stone Defenses: Life+20%","140","Advanced Construction\nHigh-Rise Def II","10","6",false,[],[]],
    ["Economy Building","Climate Control","Wonder: The Crystal Palace","200","Advanced Construction\nInsulating Materials","10","7",false,[],[]],
    ["Military Building","Armored Attack Station","New Structure: Advanced Outpost\nEmpire Points+200\n(Infected Swarm Missions)","120","Advanced Construction\nAutonomous Weapons","10","8",false,[],[]],

    ["Military Tech","High Voltage Ionizer","Shocking Tower: Range+1","180","Advanced Construction\nPlasma Spheres","11","1",false,[],[]],
    ["Economy Building\nMilitary Building","Advanced Machinery","New Structure: Foundry\nNew Structure: Oil Platform","280","Advanced Construction","11","4",false,[],[]],
    ["Economy Building","Bronze Forging","Wonder: The Victorious","200","Advanced Construction\nReinforced Concrete","11","6",false,[],[]],
    ["Military Tech","Monuments","Inn: Prestige+50%","120","Advanced Construction\nClimate Control","11","7",false,[],[]],

    ["Economy Building","Ray Condenser","Wonder: The Lightning Spire","200","Advanced Machinery\nAdvanced Tesla Transfer","12","0",false,[],[]],
    ["Building\nUnit","Mechanical Engineering","New Structure: Engineering Center\nNew Unit: Lucifer","160","Advanced Machinery","12","2",false,[],[]],
    ["Economy Building","Steel Turbines","New Structure: Advanced Mill","140","Advanced Machinery","12","3",false,[],[]],
    ["Economy Building","Biochemistry","New Structure: Advanced Farm","160","Advanced Machinery","12","5",false,[],[]],
    ["Military Tech","Titanium","Buildings: Def+10%","120","Advanced Machinery","12","7",false,[],[]],
    ["Economy Tech\nTrain","Oil Transportation","Train Oil+5 (Every 24h)","240","Advanced Machinery\nIron Transportation","12","9",false,[],[]],

    ["Economy Tech","Pneumatic Joints","Oil Platform: Oil+1","120","Advanced Machinery\nMechanical Engineering","13","1",false,[],[]],
    ["Military Building","Radar","New Structure: Radar Tower","140","Advanced Machinery\nMechanical Engineering","13","2",false,[],[]],
    ["Research","Advanced Research","Research: Time-25%","140","Advanced Machinery\nSteel Turbines","13","3",false,[],[]],
    ["Economy Tech","Tungsten Saw","Sawmill: Wood+10%","120","Advanced Machinery\nTitanium","13","6",false,[],[]],
    ["Economy Building","Tungsten Tools","New Structure: Advanced Quarry","160","Advanced Machinery\nTitanium","13","7",false,[],[]],
    ["Military Building","Barbed Wire","New Structure: Wire Fence Trap","120","Advanced Machinery\nTitanium","13","8",false,[],[]],

    ["Unit","Mechanical Exoskeletons","New Unit: Thanatos","180","Advanced Machinery\nPneumatic Joints","14","0",false,[],[]],
    ["Unit","Articulated Vehicles","New Unit: Titan","180","Advanced Machinery\nPneumatic Joints","14","1",false,[],[]],
    ["Military Building","Combat Artillery","New Structure: Executor","180","Advanced Machinery\nRadar","14","2",false,[],[]],
    ["Economy Building","Chemical Transmutation","Wonder: The Atlas Transmutator","200","Advanced Machinery\nBiochemistry","14","5",false,[],[]],
    ["Military Tech","Carbon Steel","Wire Fence Trap: Life+30%","140","Advanced Machinery\nBarbed Wire","14","8",false,[],[]],

    ["Economy Tech","High Technology","Structures: Build Time-10%","300","Advanced Machinery","15","4",false,[],[]],
    ["Economy Tech\nTrain","Ingot Transportation","Train Gold+300 (Every 24h)","300","High Technology\nOil Transportation","15","9",false,[],[]],

    ["Military Tech","Advanced Ammunition","Soldier: Damage+30%","180","High Technology\nAssault Rifle","16","0",false,[],[]],
    ["Military Tech","Nanomaterials","Units: Armor+5%","200","High Technology","16","2",false,[],[]],
    ["Military Tech","Superconductors","Shocking Tower: Energy-30%","180","High Technology","16","6",false,[],[]],
    ["Military Tech","Music","Inn: Mercs q2days","200","High Technology\nGames and Gambling","16","8",false,[],[]],

    ["Military Tech","Laser","Titan: Damage+25%","200","High Technology\nArticulated Vehicles\nAdvanced Ammunition","17","0",false,[],[]],
    ["Unit","Genetic Engineering","New Unit: Mutant","300","High Technology\nMechanical Engineering\nNanomaterials","17","1",false,[],[]],
    ["Military Tech","Augmented Reality","Sniper: Range+1\nDamage+20%","220","High Technology\nTelescopic Sight\nNanomaterials","17","2",false,[],[]],
    ["Economy Tech","Diamond Tools","Advanced Quarry: Mining+20%","240","High Technology\nTungsten Tools\nNanomaterials","17","3",false,[],[]],
    ["Military Tech","High Plasma Energy","Shocking Tower: Range+1","220","High Technology\nSuperconductors","17","5",false,[],[]],
    ["Economy Tech","Optimal Tesla Transfer","Tesla Tower: Range+1","240","High Technology\nSuperconductors","17","6",false,[],[]],
    ["Economy Tech","Solar Energy","Buildings: Energy-20%","240","High Technology\nSuperconductors","17","7",false,[],[]],
    ["Economy Tech","Deep Drilling","Oil Platform: Oil+20%","240","High Technology\nSuperconductors","17","8",false,[],[]],
    ["Military Tech\nTrain","Artillery Transportation","Train Wasp+1 (Every 24h)","400","High Technology\nIngot Transportation","17","9",false,[],[]],
  ]

var by_name = {};

var used_points = 0;

// index
for(var t of tech) {
	by_name[t[tName]] = t;
	t[tPoints] = parseInt(t[tPoints]);
}

// construct graph
for(var t of tech) {
	for(const r_name of t[tReq].split('\n')) {
		if (r_name) {
			//console.log(t[tName], r_name);
			t[tR].push(by_name[r_name]);
			by_name[r_name][tP].push(t);
		}
	}
}

function activate_tech(t) {
	if (t[tActive] == false) {
	    t[tActive] = true;
		used_points += t[tPoints];
		for(var r of t[tR]) {
			activate_tech(r);
		}		
	}
}

function deactivate_tech(t) {
	if (t[tActive] == true) {
		t[tActive] = false;
		used_points -= t[tPoints];
		for(var p of t[tP]) {
			deactivate_tech(p);
		}
	}
}
	
function toggle_tech(t) {
	if (t[tActive] == false) {
		activate_tech(t);
	}
	else {
		deactivate_tech(t);
	}

	document.getElementById("used").innerHTML = used_points.toString();
}

function show_tech(t) {
	document.getElementById("desc").innerHTML = t[tName]+"\n\n"+t[tEffect];
}

function get_tech_by_mouse_pos(e) {
	var gx = Math.trunc((e.offsetX-27+bg_pos)/300);
	var gy = Math.trunc((e.offsetY-15)/63);
	
	for(var t of tech) {
		if (t[tX] == gx && t[tY] == gy) {
			return t;
		}
	}
	return null;
}

var bg=new Image();
var bg_pos=400;
const bg_w=5422;
const bg_h=665;

	
window.onload = function() {
    var canvas=document.getElementById("canvas");
    
	window.addEventListener("resize", e => {
		render();
	});
	
	var drag=false;
	var drag_start=0;
	var last_mouse_x=0;
	var total_scrolled=0;
		
	canvas.addEventListener('mousedown', e => {
	  last_mouse_x = e.offsetX;
	  drag = true;	 
	  total_scrolled=0;
	});

	canvas.addEventListener('mouseup', e => {
	  if (drag == true) {
		dx = last_mouse_x - e.offsetX;
		bg_pos += dx;
		last_mouse_x = e.offsetX;		
		total_scrolled += Math.abs(dx);
		
		drag = false;
		
		render();
	  }	  
	  
	  if (total_scrolled <= 5) {	    
	    var t = get_tech_by_mouse_pos(e);
		if (t != null) {
			toggle_tech(t);
			render();
		}
	  }
	  
	  
	  
	});

	canvas.addEventListener('mousemove', e => {
	  if (drag == true) {
	    dx = last_mouse_x - e.offsetX
		bg_pos += dx;
		last_mouse_x = e.offsetX;
		total_scrolled += Math.abs(dx);
		
		render();
	  }

		var t = get_tech_by_mouse_pos(e);
		if (t != null) {
			show_tech(t);
		}
	});
	
	document.addEventListener('keypress', e => {
		//console.log(e.code);
	});
    
    bg.onload=function(){     
	  render();
    };
    bg.src="bg.png";
  };
  
function render(){
	var canvas=document.getElementById("canvas");
	canvas.width = window.innerWidth - 100;

	var context=canvas.getContext('2d');

	bg_pos = Math.max(0, bg_pos);
	bg_pos = Math.min(bg.width - canvas.width, bg_pos);
		  
	context.drawImage(bg, bg_pos,0, canvas.width,canvas.height, 0,0, canvas.width,canvas.height);
	  
	  
	context.strokeStyle = 'white';
	context.lineWidth = 2;
	for(var t of tech) {
		if (t[tActive]) {
			var x = t[tX] * 300 + 27 - bg_pos;
			var y = t[tY] * 63 + 15;
			//console.log(x,y);
			
			context.strokeRect(x, y, 265, 54);
			
		}
	}
}

</script>
</head>
<body>
<h1>They Are Billions Tech Tree Calculator</h1>
<canvas id="canvas" width="1900" height="665">tech tree</canvas>
<h2>Tech points used: <span id="used">0</span>/10000</h2>
<pre id="desc"></pre>
</body>
</html>
